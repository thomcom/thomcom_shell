---
phase: 02-signal-hook-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - core/history.sh
autonomous: true

must_haves:
  truths:
    - "Commands are appended to history incrementally"
    - "History append happens before each prompt"
    - "CLAUDECODE agents skip incremental append"
  artifacts:
    - path: "core/history.sh"
      provides: "PROMPT_COMMAND-based incremental history"
      contains: "history -a"
  key_links:
    - from: "PROMPT_COMMAND"
      to: "history -a"
      via: "prompt hook"
      pattern: "PROMPT_COMMAND.*history -a"
---

<objective>
Add incremental history appending via PROMPT_COMMAND

Purpose: Complete the deferred INC_APPEND_HISTORY behavior from Phase 1 - bash requires `history -a` in PROMPT_COMMAND to append history incrementally
Output: History is saved after each command, not just on shell exit
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@core/history.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add PROMPT_COMMAND history append</name>
  <files>core/history.sh</files>
  <action>
Add incremental history appending at the end of the fallback section (after line 35).

Replace the comment on line 36:
```
# INC_APPEND_HISTORY deferred to Phase 2 (requires PROMPT_COMMAND)
```

With:
```bash
# Incremental history append (equivalent to zsh INC_APPEND_HISTORY)
# Skip for CLAUDECODE agents - they don't need persistent history
if [[ "$CLAUDECODE" != "1" ]]; then
    _history_append() {
        history -a  # Append new commands to HISTFILE
    }

    # Add to PROMPT_COMMAND (preserve existing hooks)
    if [[ -n "$PROMPT_COMMAND" ]]; then
        PROMPT_COMMAND="$PROMPT_COMMAND; _history_append"
    else
        PROMPT_COMMAND="_history_append"
    fi
fi
```

This ensures:
- `history -a` runs before each prompt (incremental append)
- Existing PROMPT_COMMAND hooks are preserved (important for broadcast.sh integration)
- CLAUDECODE agents skip this overhead
  </action>
  <tests skip_tests="true">
    <skip_tests_reason>PROMPT_COMMAND functionality requires interactive shell. Verified via bash -n syntax check and manual testing.</skip_tests_reason>
  </tests>
  <verify>
    bash -n core/history.sh  # Must pass syntax check
    grep -q "history -a" core/history.sh  # history append command present
    grep -q "PROMPT_COMMAND" core/history.sh  # PROMPT_COMMAND integration present
    ! grep -q "INC_APPEND_HISTORY deferred" core/history.sh  # Deferred comment removed
  </verify>
  <done>
    - `history -a` is called via PROMPT_COMMAND
    - CLAUDECODE guard prevents unnecessary overhead
    - Deferred comment removed
    - File passes bash -n syntax validation
    - Incremental history behavior achieved
  </done>
</task>

</tasks>

<verification>
bash -n core/history.sh
grep "history -a" core/history.sh
grep "PROMPT_COMMAND" core/history.sh
</verification>

<success_criteria>
1. core/history.sh passes bash -n
2. `history -a` is called in PROMPT_COMMAND hook
3. CLAUDECODE agents skip the hook
4. No deferred/TODO comments remain
</success_criteria>

<output>
After completion, create `.planning/phases/02-signal-hook-migration/02-02-SUMMARY.md`
</output>
