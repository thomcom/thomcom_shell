---
phase: 02-signal-hook-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - features/broadcast.sh
autonomous: true

must_haves:
  truths:
    - "USR1 signal triggers broadcast checking"
    - "PROMPT_COMMAND periodically checks broadcasts"
    - "Exit cleanup removes broadcast state file"
    - "zbc sends USR1 to all bash processes"
  artifacts:
    - path: "features/broadcast.sh"
      provides: "Signal handlers and PROMPT_COMMAND hooks"
      contains: "trap '_check_broadcasts' USR1"
  key_links:
    - from: "zbc function"
      to: "other bash processes"
      via: "pkill -USR1 -x bash"
      pattern: "pkill.*USR1.*bash"
    - from: "PROMPT_COMMAND"
      to: "_check_broadcasts"
      via: "periodic hook"
      pattern: "PROMPT_COMMAND.*_broadcast_precmd"
---

<objective>
Enable bash signal handlers and PROMPT_COMMAND hooks in the broadcast system

Purpose: Complete SIG-01, SIG-02, SIG-03, HOOK-01 - the TODO Phase 2 stubs in features/broadcast.sh are ready, just need to uncomment and validate
Output: Working broadcast system with USR1 trap, PROMPT_COMMAND integration, and EXIT cleanup
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@features/broadcast.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable signal handlers and hooks</name>
  <files>features/broadcast.sh</files>
  <action>
Uncomment and finalize the TODO Phase 2 sections in features/broadcast.sh:

1. **Line 86**: Uncomment `trap '_check_broadcasts' USR1` to enable signal-based broadcast delivery

2. **Lines 88-101**: Uncomment the PROMPT_COMMAND integration block:
   - Remove the comment markers from the `if [[ "$CLAUDECODE" != "1" ]]` block
   - The `_broadcast_precmd` function should call `_check_broadcasts` every 10 commands
   - The PROMPT_COMMAND append logic handles existing PROMPT_COMMAND values

3. **Lines 126-129**: Uncomment the EXIT trap block:
   - Remove the comment markers from the `if [[ "$CLAUDECODE" != "1" ]]` block
   - `trap '_cleanup_broadcast_state' EXIT` ensures state file cleanup on shell exit

Remove the "TODO Phase 2:" comment prefixes as well - those are no longer TODOs.

The code is already valid bash (verified in Phase 1), just needs uncommenting.
  </action>
  <tests skip_tests="true">
    <skip_tests_reason>Signal and PROMPT_COMMAND functionality cannot be unit tested - requires interactive shell with multiple processes. Integration testing in Phase 4.</skip_tests_reason>
  </tests>
  <verify>
    bash -n features/broadcast.sh  # Must pass syntax check
    grep -q "^trap '_check_broadcasts' USR1" features/broadcast.sh  # USR1 trap uncommented
    grep -q "^[[:space:]]*trap '_cleanup_broadcast_state' EXIT" features/broadcast.sh  # EXIT trap uncommented
    grep -q "_broadcast_precmd" features/broadcast.sh | grep -v "^#"  # PROMPT_COMMAND hook uncommented
  </verify>
  <done>
    - `trap '...' USR1` line is active (not commented)
    - `trap '...' EXIT` line is active within CLAUDECODE guard
    - `_broadcast_precmd` function is defined and hooked into PROMPT_COMMAND
    - File passes bash -n syntax validation
    - SIG-01, SIG-02, SIG-03, HOOK-01 requirements satisfied
  </done>
</task>

</tasks>

<verification>
bash -n features/broadcast.sh
grep -c "TODO Phase 2" features/broadcast.sh  # Should be 0
grep "^trap" features/broadcast.sh  # Should show USR1 trap
</verification>

<success_criteria>
1. features/broadcast.sh passes bash -n
2. No "TODO Phase 2" comments remain
3. USR1 trap is active
4. EXIT trap is active (within CLAUDECODE guard)
5. PROMPT_COMMAND integration is active (within CLAUDECODE guard)
</success_criteria>

<output>
After completion, create `.planning/phases/02-signal-hook-migration/02-01-SUMMARY.md`
</output>
